
cmake_minimum_required(VERSION 3.12)

set(PICO_BOARD pico_w)
set(USER_AGENT ANON)
# The Rhaspberry Pi logo as a Base64 png.
set(IMG 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)

# Pull in SDK (must be before project)
include(pico_sdk_import.cmake)
#include(pico_extras_import_optional.cmake)

project(picow_img_discord C CXX ASM)

set(CMAKE_C_STANDARD 11)
set(CMAKE_CXX_STANDARD 17)

set(CMAKE_BUILD_TYPE Release)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fno-trapping-math -fno-rounding-math -fno-signaling-nans -fno-signed-zeros")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3 -Wall")

# Initialize the SDK
pico_sdk_init()

add_executable(picow_img_discord
        src/main.cpp
        src/tls.c
)

# For monitoring over usb.
# E.g. $ minicom -b 115200 -o -D /dev/ttyACM0
pico_enable_stdio_usb(picow_img_discord 1)
pico_enable_stdio_uart(picow_img_discord 0)

# These secrets are stored in plaintext...
target_compile_definitions(picow_img_discord PRIVATE
        WIFI_SSID=\"${WIFI_SSID}\"
        WIFI_PASSWORD=\"${WIFI_PASSWORD}\"
        WEBHOOK=\"${WEBHOOK}\"
        USER_AGENT=\"${USER_AGENT}\"
        IMG=\"${IMG}\"
        ADC_VREF=${ADC_VREF}
        DEGREE_OFFSET=${DEGREE_OFFSET}
        ALTCP_MBEDTLS_AUTHMODE=MBEDTLS_SSL_VERIFY_REQUIRED
)

include_directories(include)

target_link_libraries(picow_img_discord
        pico_cyw43_arch_lwip_threadsafe_background
        pico_lwip_mbedtls
        pico_mbedtls
        pico_stdlib
)

pico_add_extra_outputs(picow_img_discord)

# Ignore warnings from lwip code
set_source_files_properties(
        ${PICO_LWIP_PATH}/src/apps/altcp_tls/altcp_tls_mbedtls.c
        PROPERTIES
        COMPILE_OPTIONS "-Wno-unused-result"
)
